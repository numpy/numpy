name: Alpine musl BLAS preload

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  alpine-musl-smoke:
    runs-on: ubuntu-latest
    container:
      image: quay.io/pypa/musllinux_1_2_x86_64
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install system deps
        run: |
          set -eux
          apk update --quiet
          apk add --no-cache python3 py3-pip python3-dev build-base openblas-dev lapack-dev gfortran musl-dev git
          ln -sf /usr/bin/python3 /usr/bin/python

      - name: Set up venv and install
        run: |
          set -eux
          python -m venv /tmp/venv
          . /tmp/venv/bin/activate
          pip install -U pip setuptools wheel
          pip install -U cython meson-python pytest pytest-xdist
          pip install -r requirements/test_requirements.txt
          pip install .

      - name: Test on Alpine (no LD_PRELOAD)
        run: |
          set -eux
          cd /tmp
          PYTHONNOUSERSITE=1 /tmp/venv/bin/python - <<'PY'
          import numpy, sys
          print("NumPy", numpy.__version__)
          res = numpy.test(verbose=0, extra_argv=["-q", "-k", "not test_to_ctypes"])
          sys.exit(0 if res else 1)
          PY

      - name: Test on Alpine (with LD_PRELOAD)
        run: |
          set -eux
          cd /tmp
          LD_PRELOAD=/usr/lib/libopenblas.so.3 PYTHONNOUSERSITE=1 /tmp/venv/bin/python - <<'PY'
          import numpy, sys
          print("NumPy", numpy.__version__, "(LD_PRELOAD openblas)")
          res = numpy.test(verbose=0, extra_argv=["-q", "-k", "not test_to_ctypes"])
          sys.exit(0 if res else 1)
          PY
